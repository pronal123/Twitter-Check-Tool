<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- titleã¯Flaskã«ã‚ˆã£ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹å¤‰æ•°ã§ã™ -->
    <title>{{ title }}</title> 
    <!-- Tailwind CSS CDNã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ¢ãƒã‚¤ãƒ«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å®Ÿç¾ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 'Inter'ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã€ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®èƒŒæ™¯ã‚’è¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark Mode Color */
        }
        /* ãƒ¬ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .report-card {
            background-color: #161b22; /* Slightly lighter than body for contrast */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.7);
        }
        /* äºˆæ¸¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .pulse-red {
            animation: pulse-red-anim 2s infinite;
        }
        @keyframes pulse-red-anim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .pulse-green {
            animation: pulse-green-anim 2s infinite;
        }
        @keyframes pulse-green-anim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body class="p-4 md:p-8 text-white min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <!-- titleå¤‰æ•°ã‚’ä½¿ç”¨ (ä¾‹: MLæ´»ç”¨å…ˆç‰©BOTåˆ†æãƒ¬ãƒãƒ¼ãƒˆ) -->
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-400">{{ title }}</h1>
            <p id="status-text" class="mt-2 text-sm text-gray-400">
                BOTã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="bot-status" class="font-semibold text-yellow-500">åˆæœŸåŒ–ä¸­...</span>
            </p>
        </header>

        <section id="report-container" class="space-y-8">
            <!-- Loading State: åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã«è¡¨ç¤º -->
            <div id="loading-state" class="text-center p-12 report-card rounded-xl">
                <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-lg font-medium text-gray-300">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€MLãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã§ã™...</p>
                <p class="text-sm text-gray-500 mt-2">ã“ã‚Œã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <!-- Report Content: ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããŸã‚‰è¡¨ç¤º -->
            <div id="report-content" class="hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Card 1: ç¾åœ¨ã®ä¾¡æ ¼ -->
                    <div class="report-card p-4 rounded-xl text-center">
                        <p class="text-sm text-gray-400">æœ€æ–°ã®çµ‚å€¤ (USD)</p>
                        <p id="current-price" class="text-2xl font-bold mt-1 text-white">--</p>
                    </div>
                    <!-- Card 2: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— -->
                    <div class="report-card p-4 rounded-xl text-center">
                        <p class="text-sm text-gray-400">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥æ™‚</p>
                        <p id="report-timestamp" class="text-lg font-bold mt-1 text-gray-300">--</p>
                    </div>
                    <!-- Card 3: æ¬¡å›ã®äºˆæ¸¬å®Ÿè¡Œæ™‚åˆ» -->
                    <div class="report-card p-4 rounded-xl text-center">
                        <p class="text-sm text-gray-400">æ¬¡å›ã®äºˆæ¸¬å®Ÿè¡Œ</p>
                        <p id="next-run" class="text-lg font-bold mt-1 text-gray-300">--</p>
                    </div>
                </div>

                <!-- Prediction Card: æœ€ã‚‚é‡è¦ãªäºˆæ¸¬çµæœ -->
                <div id="prediction-card" class="report-card p-6 rounded-xl border-t-4 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 flex items-center text-blue-300">
                        <!-- Lucide Icon: Trending Up/Down -->
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹æ¬¡ã®æ—¥è¶³äºˆæ¸¬
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <!-- äºˆæ¸¬ã‚¢ã‚¤ã‚³ãƒ³ (çµµæ–‡å­—) -->
                            <p id="prediction-icon" class="text-6xl transition-transform duration-500"></p>
                        </div>
                        <div>
                            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (BUY/SELL/HOLD) -->
                            <p id="prediction-action" class="text-4xl font-extrabold"></p>
                            <!-- ä¿¡é ¼åº¦ -->
                            <p class="text-md text-gray-400 mt-1">ä¿¡é ¼åº¦: <span id="confidence-value" class="font-bold text-white">--</span></p>
                        </div>
                    </div>
                    <!-- èª¬æ˜æ–‡ -->
                    <p id="prediction-explanation" class="mt-4 text-gray-300 border-t border-gray-700 pt-4"></p>
                </div>

                <!-- Advanced/Technical Metrics: è©³ç´°ãƒ‡ãƒ¼ã‚¿ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Technical Metrics (ç‰¹å¾´é‡) -->
                    <div class="report-card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-blue-400">ä¸»è¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã®ã¾ã¨ã‚</h2>
                        <div id="metrics-list" class="grid grid-cols-1 gap-3">
                            <!-- Technical Metrics will be inserted here by JS -->
                        </div>
                    </div>
                    
                    <!-- Advanced Metrics (å¤–éƒ¨æƒ…å ±) -->
                    <div class="report-card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-purple-400">é«˜åº¦ãªå¸‚å ´ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ (BOTãŒä½¿ç”¨)</h2>
                        <div id="advanced-metrics-list" class="grid grid-cols-1 gap-3">
                             <!-- Advanced Metrics will be inserted here by JS -->
                        </div>
                        <p class="text-xs text-gray-500 mt-4">â€»ã“ã‚Œã‚‰ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªå¸‚å ´åˆ†æã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚</p>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <script>
        const API_URL = window.location.origin;
        const INTERVAL_MS = 10000; // 10ç§’ã”ã¨ã«æ›´æ–°

        // å€¤ã‚’USãƒ‰ãƒ«ã®é€šè²¨å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const formatCurrency = (value) => {
            if (value === undefined || value === null) return '--';
            // æ•°å€¤ãŒéå¸¸ã«å¤§ãã„å ´åˆã¯ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã§è¡¨ç¤º
            return parseFloat(value).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const renderMetrics = (containerId, metrics, isAdvanced = false) => {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // ä»¥å‰ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢

            if (!metrics) return;

            for (const [key, value] of Object.entries(metrics)) {
                let formattedValue = typeof value === 'number' ? value.toFixed(4) : value;
                
                // é€šè²¨å€¤ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                if (typeof value === 'number' && (key.toLowerCase().includes('usd') || key.toLowerCase().includes('interest'))) {
                     formattedValue = formatCurrency(value);
                }
                
                const keyColor = isAdvanced ? 'text-purple-300' : 'text-blue-300';
                
                // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ã®HTMLæ§‹é€ 
                const metricHtml = `
                    <div class="flex justify-between items-center p-3 border border-gray-800 rounded-lg bg-[#21262d]">
                        <span class="text-gray-400 text-sm ${keyColor} font-medium">${key}</span>
                        <span class="font-mono font-bold text-white">${formattedValue}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', metricHtml);
            }
        }


        // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã¨è¡¨ç¤º
        async function fetchReport() {
            try {
                const response = await fetch(`${API_URL}/get_report`);
                
                if (!response.ok) {
                    // ãƒ¬ãƒãƒ¼ãƒˆãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ãªã„å ´åˆ (503 Service Unavailable)
                    if (response.status === 503) return; 
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const report = await response.json();

                // --- ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ ---
                document.getElementById('current-price').textContent = formatCurrency(report.current_price);
                document.getElementById('report-timestamp').textContent = report.timestamp;
                
                // --- äºˆæ¸¬ã‚«ãƒ¼ãƒ‰ã®æ›´æ–° ---
                const card = document.getElementById('prediction-card');
                const actionElement = document.getElementById('prediction-action');
                const iconElement = document.getElementById('prediction-icon');
                const confidenceValue = document.getElementById('confidence-value');
                const explanationElement = document.getElementById('prediction-explanation');

                actionElement.textContent = report.prediction.action;
                confidenceValue.textContent = report.prediction.confidence_score;
                explanationElement.textContent = report.prediction.explanation;

                // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦è‰²ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                card.classList.remove('border-red-500', 'border-green-500', 'border-yellow-500');
                iconElement.classList.remove('text-red-500', 'text-green-500', 'text-yellow-500', 'pulse-red', 'pulse-green');
                actionElement.classList.remove('text-red-500', 'text-green-500', 'text-yellow-500');


                if (report.prediction.action.includes('BUY')) {
                    card.classList.add('border-green-500');
                    iconElement.classList.add('text-green-500', 'pulse-green');
                    actionElement.classList.add('text-green-500');
                    iconElement.textContent = 'ğŸš€'; // ä¸Šæ˜‡
                } else if (report.prediction.action.includes('SELL')) {
                    card.classList.add('border-red-500');
                    iconElement.classList.add('text-red-500', 'pulse-red');
                    actionElement.classList.add('text-red-500');
                    iconElement.textContent = 'ğŸ“‰'; // ä¸‹è½
                } else {
                    card.classList.add('border-yellow-500');
                    iconElement.classList.add('text-yellow-500');
                    actionElement.classList.add('text-yellow-500');
                    iconElement.textContent = 'â¸ï¸'; // ãƒ›ãƒ¼ãƒ«ãƒ‰
                }
                
                // ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã¨é«˜åº¦ãªæŒ‡æ¨™ã®è¡¨ç¤º
                renderMetrics('metrics-list', report.technical_metrics, false);
                renderMetrics('advanced-metrics-list', report.advanced_metrics, true);


                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’éè¡¨ç¤ºã«ã—ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('report-content').classList.remove('hidden');

            } catch (error) {
                console.error("ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                // åˆå›ãƒ­ãƒ¼ãƒ‰ã§å¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (document.getElementById('report-content').classList.contains('hidden')) {
                     document.getElementById('loading-state').innerHTML = `
                        <p class="text-lg font-medium text-red-500">ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                        <p class="text-sm text-gray-500 mt-2">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    `;
                }
            }
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã¨æ¬¡å›ã®å®Ÿè¡Œæ™‚é–“ã‚’å–å¾—
        async function fetchStatus() {
            try {
                const response = await fetch(`${API_URL}/report_status`);
                const status = await response.json();
                
                const statusElement = document.getElementById('bot-status');
                const nextRunElement = document.getElementById('next-run');
                
                statusElement.textContent = status.status;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
                statusElement.classList.remove('text-yellow-500', 'text-red-500', 'text-green-500');
                if (status.status.includes('ç¨¼åƒä¸­')) {
                    statusElement.classList.add('text-green-500');
                } else {
                    statusElement.classList.add('text-yellow-500');
                }

                // æ¬¡å›ã®äºˆæ¸¬å®Ÿè¡Œæ™‚é–“ã‚’è¡¨ç¤º
                nextRunElement.textContent = status.next_prediction;

            } catch (error) {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹APIãŒåˆ©ç”¨ã§ããªã„å ´åˆ
                console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                document.getElementById('bot-status').textContent = 'APIæ¥ç¶šã‚¨ãƒ©ãƒ¼';
                document.getElementById('bot-status').classList.remove('text-green-500', 'text-yellow-500');
                document.getElementById('bot-status').classList.add('text-red-500');
            }
        }

        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¨å®šæœŸçš„ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            fetchReport();
            
            // 10ç§’ã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            setInterval(fetchStatus, INTERVAL_MS); 
            setInterval(fetchReport, INTERVAL_MS);
        });

    </script>
</body>
</html>
