<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald green
                        'secondary': '#374151', // Gray-700
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-once {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        .pulsing-dot {
            animation: pulse-once 1.5s ease-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        
        <!-- ヘッダー -->
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-secondary tracking-tight border-b-4 border-primary pb-2 inline-block">
                {{ title }}
            </h1>
        </header>

        <!-- ステータスセクション -->
        <section class="mb-10 bg-white shadow-xl rounded-xl p-6 border-t-4 border-primary">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                システム稼働状況
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                
                <!-- 最終更新日時カード -->
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500 uppercase">最終レポート更新</p>
                    <p id="last-updated" class="text-xl md:text-2xl font-bold text-gray-900 mt-1 break-words">
                        {{ data['last_updated'] }}
                    </p>
                </div>

                <!-- スケジューラーステータスカード -->
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500 uppercase">スケジューラー状態</p>
                    <div class="flex items-center justify-center mt-1">
                        <span id="scheduler-status-dot" class="w-3 h-3 rounded-full bg-primary pulsing-dot mr-2"></span>
                        <p id="scheduler-status" class="text-xl md:text-2xl font-bold text-gray-900">
                            {{ data['scheduler_status'] }}
                        </p>
                    </div>
                </div>

                <!-- データ件数カード -->
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500 uppercase">処理データ件数</p>
                    <p id="data-count" class="text-xl md:text-2xl font-bold text-gray-900 mt-1">
                        {{ data['data_count'] }} 件
                    </p>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-primary/10 rounded-lg text-center">
                <p class="text-sm font-medium text-gray-700">データ取得期間:</p>
                <p id="data-range" class="text-lg font-mono text-primary break-words mt-1">{{ data['data_range'] }}</p>
            </div>
        </section>

        <!-- レポート概要 -->
        <section class="bg-white shadow-xl rounded-xl p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                最新分析結果のサマリー
            </h2>
            <div class="space-y-4 text-gray-700">
                <p>このセクションには、定期的に更新される機械学習モデルによる分析結果や、トレードの推奨事項が表示されます。アプリケーションのバックエンド（`app.py`）で実行されているタスクは、現在、データ取得をシミュレーションしています。</p>
                <ul class="list-disc list-inside ml-4 space-y-2">
                    <li>**ボラティリティ指標:** 現在の市場は中程度のボラティリティを示しています。</li>
                    <li>**モデル推奨:** 短期的なレンジ取引（RSIに基づく）が推奨されます。</li>
                    <li>**次回の予測実行:** スケジュールに従って1分以内に更新されます。</li>
                </ul>
                <p class="text-sm text-gray-500 mt-4 border-l-4 border-gray-300 pl-3">
                    注意: このページに表示されるデータはダミーであり、実際の金融取引情報ではありません。
                </p>
            </div>
        </section>

    </div>

    <script>
        // グローバル変数を設定 (HTMLテンプレートから初期値を引き継ぐ)
        let globalData = {
            last_updated: "{{ data['last_updated'] }}",
            data_range: "{{ data['data_range'] }}",
            data_count: "{{ data['data_count'] }}",
            scheduler_status: "{{ data['scheduler_status'] }}"
        };

        const updateUI = (data) => {
            const lastUpdatedEl = document.getElementById('last-updated');
            const dataRangeEl = document.getElementById('data-range');
            const dataCountEl = document.getElementById('data-count');
            const schedulerStatusEl = document.getElementById('scheduler-status');
            const statusDotEl = document.getElementById('scheduler-status-dot');

            // 最終更新日時
            if (data.last_updated !== globalData.last_updated) {
                lastUpdatedEl.textContent = data.last_updated;
                // 更新があった場合に視覚的なフィードバック（ドットのパルスアニメーションをリセット）
                statusDotEl.classList.remove('pulsing-dot');
                void statusDotEl.offsetWidth; // 強制的にリフロー
                statusDotEl.classList.add('pulsing-dot');
            }

            // データ範囲と件数
            dataRangeEl.textContent = data.data_range;
            dataCountEl.textContent = data.data_count + ' 件';
            
            // スケジューラーステータス
            schedulerStatusEl.textContent = data.scheduler_status;
            
            // グローバルデータの更新
            globalData = data;
        };

        const fetchStatus = async () => {
            try {
                const response = await fetch('/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error("ステータス取得エラー:", error);
                // エラー時もUIを更新し、稼働状況を反映
                document.getElementById('scheduler-status').textContent = 'エラー発生';
                document.getElementById('scheduler-status-dot').classList.remove('bg-primary', 'pulsing-dot');
                document.getElementById('scheduler-status-dot').classList.add('bg-red-500');
            }
        };

        window.onload = () => {
            // 5秒ごとに最新のステータスを取得
            setInterval(fetchStatus, 5000);
            
            // 初回表示のタイミングでUIが初期化されることを確認
            // Flaskのテンプレートで初期値が埋め込まれているため、初回は不要だが念のため
            fetchStatus(); 
        };
    </script>
</body>
</html>
